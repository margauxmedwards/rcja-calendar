<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.2/dist/semantic.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.2/dist/semantic.min.js"></script>

    <title>RCJQ – Queensland Regional Calendar</title>

    <style>
        body {
            background-image: url("/homeimage.jpg");
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            background-attachment: fixed;
            min-height: 100vh;
        }

        .main-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
        }

        .region-card .region-header {
            background-color: #f78c6b;
            color: white;
            padding: 10px 14px;
            margin: -14px -14px 14px -14px;
            border-radius: 4px 4px 0 0;
            font-size: 1.1em;
            font-weight: bold;
        }

        .event-item.highlighted {
            border-left: 4px solid #f78c6b;
            background-color: #fff8f5 !important;
        }

        .event-date {
            font-weight: bold;
            color: #555;
            min-width: 65px;
            display: inline-block;
        }

        .no-events {
            color: #aaa;
            font-style: italic;
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="ui segment">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <h1 class="ui header" style="margin: 0;">
                    <img src="/favicon-32x32.png" class="ui image" style="margin-right: 8px; vertical-align: middle;">
                    RCJQ – Queensland Regional Calendar
                </h1>
                <div>
                    <a class="ui button primary" href="/">
                        <i class="calendar icon"></i> Full Calendar
                    </a>
                    <a class="ui button" href="/sync">
                        <i class="sync icon"></i> Sync
                    </a>
                </div>
            </div>

            <div class="ui divider"></div>

            <div id="loading" class="loading-spinner">
                <div class="ui active inline loader"></div>
                <p>Loading Queensland events…</p>
            </div>

            <div id="error-msg" class="ui error message" style="display: none;">
                <div class="header">Error loading events</div>
                <p id="error-text"></p>
            </div>

            <div id="regions-container" class="ui four stackable cards" style="display: none;">
                <!-- Region cards are rendered here by JavaScript -->
            </div>

            <div class="ui secondary mini menu" style="margin-top: 16px;">
                <div class="item" id="last-updated">
                    <i class="clock outline icon"></i> –
                </div>
                <div class="right item">
                    <button class="ui mini button" onclick="refreshData()">
                        <i class="sync icon"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
    const regionOrder = ["seq", "wide-bay", "downs", "fnq"];

    function escapeHtml(str) {
        return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;");
    }

    function renderRegions(data) {
        const container = document.getElementById("regions-container");
        container.innerHTML = "";

        for (const regionKey of regionOrder) {
            const region = data[regionKey];
            if (!region) continue;

            const events = region.events || [];

            let eventsHtml;
            if (events.length === 0) {
                eventsHtml = '<div class="item"><span class="no-events">No upcoming events</span></div>';
            } else {
                eventsHtml = events.map(event => {
                    const registerLink = event.registrationURL
                        ? `<div class="extra"><a href="${escapeHtml(event.registrationURL)}" target="_blank" rel="noopener">Register →</a></div>`
                        : "";
                    return `
                        <div class="item event-item${event.highlight ? " highlighted" : ""}">
                            <div class="content">
                                <div class="header">
                                    <span class="event-date">${escapeHtml(event.date)}</span>
                                    ${event.highlight ? '<span class="ui orange horizontal label" style="margin-left:4px;">⭐ State</span>' : ""}
                                    ${escapeHtml(event.name)}
                                </div>
                                <div class="description">${escapeHtml(event.desc)}</div>
                                ${registerLink}
                            </div>
                        </div>`;
                }).join("");
            }

            container.innerHTML += `
                <div class="card region-card">
                    <div class="content">
                        <div class="region-header">${escapeHtml(region.title)}</div>
                        <div class="ui relaxed divided list">
                            ${eventsHtml}
                        </div>
                    </div>
                </div>`;
        }
    }

    function refreshData() {
        document.getElementById("loading").style.display = "";
        document.getElementById("regions-container").style.display = "none";
        document.getElementById("error-msg").style.display = "none";

        $.ajax({
            url: "/api/qld/regions",
            type: "GET",
            dataType: "json",
            success: function (data) {
                renderRegions(data);
                document.getElementById("loading").style.display = "none";
                document.getElementById("regions-container").style.display = "";
                document.getElementById("last-updated").innerHTML =
                    '<i class="clock outline icon"></i> Last updated: ' +
                    new Date().toLocaleTimeString("en-AU");
            },
            error: function (err) {
                document.getElementById("loading").style.display = "none";
                document.getElementById("error-text").textContent =
                    (err.responseJSON && err.responseJSON.error) ||
                    "Failed to load events. Please try again.";
                document.getElementById("error-msg").style.display = "";
            }
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        refreshData();
        // Auto-refresh every 5 minutes
        setInterval(refreshData, 5 * 60 * 1000);
    });
</script>
</body>
</html>
